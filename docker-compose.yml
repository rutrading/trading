services:
  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: trading
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  market-data:
    build:
      context: .
      dockerfile: backend/services/market_data/Dockerfile
    ports:
      - "50051:50051"
    environment:
      MARKET_DATA_HOST: "0.0.0.0:50051"
      TRANSFORMER_HOST: "transformer:50052"
      TWELVE_DATA_API_KEY: ${TWELVE_DATA_API_KEY:-}
      TWELVE_DATA_BASE_URL: "https://api.twelvedata.com"
      LOG_LEVEL: INFO

  transformer:
    build:
      context: .
      dockerfile: backend/services/transformer/Dockerfile
    ports:
      - "50052:50052"
    environment:
      TRANSFORMER_HOST: "0.0.0.0:50052"
      LOG_LEVEL: INFO

  filter:
    build:
      context: .
      dockerfile: backend/services/filter/Dockerfile
    ports:
      - "50053:50053"
    environment:
      FILTER_HOST: "0.0.0.0:50053"
      DATABASE_URL: "postgresql://postgres:postgres@db:5432/trading"
      LOG_LEVEL: INFO
    depends_on:
      - db

  scheduler:
    build:
      context: .
      dockerfile: backend/services/scheduler/Dockerfile
    environment:
      MARKET_DATA_HOST: "market-data:50051"
      TRANSFORMER_HOST: "transformer:50052"
      FILTER_HOST: "filter:50053"
      LOG_LEVEL: INFO
    depends_on:
      - market-data
      - transformer
      - filter

volumes:
  postgres_data:
